[Test]
SRC_DIR: 	${CMAKE_SOURCE_DIR}
BIN_DIR: 	${CMAKE_BINARY_DIR}

comp.gcc: 	 	Conf("${CMAKE_C_COMPILER}", "GCC")
comp.g++: 		Conf("${CMAKE_CXX_COMPILER}", "G++")
comp.insieme: 	Conf("%(BIN_DIR)s/code/driver/main", "InsiemeC")
comp.mpicc:		Conf("${MPI_C_COMPILER}", "MPICC")

act.sema: 		Conf(Flag("-S"), "Sema")
act.ir: 		Conf(OutFileFlag("--dump-ir", "ir"))
# act.cfg: 		Conf(OutFileFlag("--dump-cfg", "cfg"))
act.seq:		Conf(Flag("-b seq"), "Seq. Backend")
act.run:		Conf(Flag("-b run"), "Run. Backend")
act.ocl:		Conf(Flag("-b ocl"), "Ocl Backend")

front.insieme: %(comp.insieme)s + Conf([ Flag("--std=c99"), 
									     Flag("--col-wrap=120"),
										 Flag("--show-line-no"),
										 Flag("--log-level=INFO")]
									  )

# LIST of INSIEME BACKENDS
back.gcc.flags: Conf([ 
					Flag("-fshow-column"), 
					Flag("-Wall"), 
					Flag('-Wl,--no-as-needed'),
					Flag("-pipe"),
					Flag("-I.")
				])
back.gcc: 		%(back.gcc.flags)s + Conf(Flag("-std=gnu99"))
back.g++:		%(back.gcc.flags)s + Conf(Flag("-std=c++0x")) 

back.c.opt: 	Conf(Flag('-O3'))
back.seq: 		Conf(Flag("-lm"), "SEQ")
back.run:		Conf([
					Flag('-I%(SRC_DIR)s/code/runtime/include'),
					Flag('-D_XOPEN_SOURCE=700'),
					Flag('-D_GNU_SOURCE'),
					Flag('-ldl'),
					Flag('-fno-strict-aliasing')
				], "RUN")

back.ocl.common: %(back.run)s + Conf([
					Flag('-lOpenCL'), 
					Flag('-I$OPENCL_ROOT/include'),
					Flag('-L$OPENCL_ROOT/lib/x86_64'),
					Flag('-DUSE_OPENCL=ON'),
					Flag('-D_POSIX_C_SOURCE=199309')
				], "OCL")

back.ocl:   	%(back.ocl.common)s + Conf([
					Flag('-DLOCAL_MODE'),
				], "OCL_LOCAL")

back.mpi_ocl:	%(back.ocl.common)s + Conf([
					Flag('-DREMOTE_MODE'),
				], "OCL_REMOTE")


execute.seq:		Conf(Flag(''), "LOCAL_EXEC")
execute.mpi:		Conf('${MPI_C_INCLUDE_PATH}/../bin/mpirun', 'MPIRUN') + Conf([Flag('-n $SLOTS')])

# LIST OF PASSES (it's important that passes names begins with the pass keyword)
pass.00.gcc: 		Pass(None,None,%(comp.gcc)s+%(back.c.opt)s+%(back.gcc)s,'ref',%(execute.seq)s)

pass.01.mpi: 		Pass(None,None,%(comp.mpicc)s+%(back.c.opt)s+%(back.gcc)s,'ref.mpi',%(execute.mpi)s)

pass.02.g++:		Pass(None,None,%(comp.g++)s+%(back.c.opt)s+%(back.g++)s,'ref',%(execute.seq)s)

pass.05.sema: 		Pass(%(front.insieme)s+%(act.sema)s+%(act.ir)s)

# Sequential backend passes
pass.07.c_seq:   	Pass(%(front.insieme)s+%(act.seq)s, 'insieme.seq.c', 
					 %(comp.gcc)s+%(back.gcc)s+%(back.seq)s+%(back.c.opt)s, 'seq.test',%(execute.seq)s  
					)
pass.07.cxx_seq:   	Pass(%(front.insieme)s+%(act.seq)s, 'insieme.seq.cpp', 
					 %(comp.g++)s+%(back.g++)s+%(back.seq)s+%(back.c.opt)s, 'seq.test',%(execute.seq)s  
					)
pass.07.mpi_seq: 	Pass(%(front.insieme)s+%(act.seq)s, 'insieme.seq.c', 
					 %(comp.gcc)s+%(back.gcc)s+%(back.seq)s+%(back.c.opt)s, 'seq.test',%(execute.mpi)s  
					)

# Runtime backend passes
pass.09.c_run:		Pass(%(front.insieme)s+%(act.run)s, 'insieme.run.c', 
					 %(comp.gcc)s+%(back.gcc)s+%(back.run)s+%(back.c.opt)s, 'run.test',%(execute.seq)s 
					)
pass.09.cxx_run:	Pass(%(front.insieme)s+%(act.run)s, 'insieme.run.cpp', 
					 %(comp.g++)s+%(back.g++)s+%(back.run)s+%(back.c.opt)s, 'run.test',%(execute.seq)s 
					)
pass.09.win_run:	Pass(None, 'insieme.run.ref.c', 
					 %(comp.gcc)s+%(back.gcc)s+%(back.run)s+%(back.c.opt)s, 'run.test',%(execute.seq)s 
					)

# OpenCL backend passes
pass.11.ocl:		Pass(%(front.insieme)s+%(act.ocl)s, 'insieme.ocl.c',  
					 %(comp.gcc)s+%(back.gcc)s+%(back.ocl)s+%(back.c.opt)s, 'ocl.test',%(execute.seq)s
					)
pass.13.mpi_ocl:	Pass(%(front.insieme)s+%(act.ocl)s, 'insieme.ocl.c',  
					 %(comp.mpicc)s+%(back.gcc)s+%(back.mpi_ocl)s+%(back.c.opt)s, 'mpi_ocl.test', %(execute.mpi)s
					)
